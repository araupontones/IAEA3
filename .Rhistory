ungroup()
}
plot_ranks <- function(.data){
.data %>%
ggplot(
aes(x = perc,
y = reorder(aspect, times_selected),
fill = rank
)
) +
geom_col() +
lapply(c(25,50,75), function(x){
geom_vline(xintercept = x,
linetype = 'dashed')
}) +
scale_fill_brewer(breaks = rev(ranks),
labels = rev(ranks),
palette = "Greens",
name = "Ranked"
) +
scale_x_continuous(breaks = seq(0,100, 25),
labels = function(x)paste0(x, "%"),
#labels = seq(0,100, 25),
limits = c(0,100),
expand = c(0,0)
) +
scale_y_discrete(labels = label_wrap_gen(25)) +
labs(title = 'Aspects that may help ensuring sustainability of the\nachievements reached with TCP.',
subtitle = "Ranked by their piority.") +
theme_main() +
theme(legend.title = element_text())
}
ranks <- levels(global$rank)
#create data
#1. global
global<- clean_d %>% format_ranks(NULL)
#2. themes
themes <- clean_d %>%
mutate(theme = susor::susor_get_stata_labels(theme)) %>%
format_ranks(by = 'theme')
#3. Region
regions <- clean_d %>%
format_ranks(by = 'region')
global_plot <- global %>% plot_ranks()
themes_plot <- themes  %>% plot_ranks() + facet_wrap(~theme)
regions_plot <- regions  %>% plot_ranks() + facet_wrap(~region)
ggsave('analysis/plots/1.future/cp/global_future.png',
global_plot)
ggsave('analysis/plots/1.future/cp/themes_future.png',
themes_plot)
ggsave('analysis/plots/1.future/cp/regions_future.png',
regions_plot)
regions_plot
#Clean data for Institutions
# All institutions for a single project come together in a single cell
# Thus, it is neccessary to unnest them and to crate a table where each row is
# an institution supported in each project
library(rio)
library(dplyr)
library(tidyr)
library(janitor)
library(stringr)
gmdacr::load_functions('functions')
projects <- import('data/1.reference/Copy of CPs_2022_09_12.xlsx')
names(projects)
#Drop observations with missing contact information ===========================
#create_df_complete is in /functions
df_complete <- create_df_complete(projects)
names(df_complete)
institutions_id <- df_complete %>%
#Select relevant variables
select(Index, ProjectNumber, FOADescription,Country,Area,Institution, Name, EMail, Nationality) %>%
#create a row by each institution of the project
separate(Institution,paste0("inst_",c(1:9)), ";") %>%
pivot_longer(-c(Index, Country,Area, Name, EMail,ProjectNumber, FOADescription, Nationality),
values_to = "Institution") %>%
select(-name) %>%
filter(!is.na(Institution)) %>%
#clean some institutions,
#this could take a long time. There are many cases of the same institution written
#differently
mutate(Institution = stringr::str_trim(Institution)) %>%
distinct() %>%
filter(!Institution %in% c('.', "", "•")) %>%
mutate(Institution = case_when(str_detect(Institution, "COMENA") ~ "Commissariat à l'énergie atomique (COMENA)",
str_detect(Institution, "AAEHC") ~ "Afghanistan Atomic Energy High Commission (AAEHC)",
str_detect(Institution, "AMARAP") ~ "Agence Malienne de Radioprotection (AMARAP)",
T ~ Institution))
View(institutions_id)
tabyl(institutions_id, Country)
create_df_complete <- function(.data, drop_na_email = F){
if(drop_na_email){
d1 <- .data %>%
filter(!is.na(EMail),
!is.na(Institution),
Institution != "",
Nationality != "NULL")
} else {
d1 <- .data
}
}
create_df_complete <- function(.data, drop_na_email = T){
if(drop_na_email){
d1 <- .data %>%
filter(!is.na(EMail),
!is.na(Institution),
Institution != "",
Nationality != "NULL")
} else {
d1 <- .data
}
}
#Drop observations with missing contact information ===========================
#create_df_complete is in /functions
df_complete <- create_df_complete(projects)
library(rio)
library(dplyr)
library(tidyr)
library(janitor)
library(stringr)
gmdacr::load_functions('functions')
projects <- import('data/1.reference/Copy of CPs_2022_09_12.xlsx')
foas_projects <- projects %>% group_by(FOACode, FOADescription) %>%
slice(1)
View(foas_projects)
foas_projects <- projects %>% group_by(FOACode, FOADescription) %>%
summarise(total_projects = n())
View(foas_projects)
library(googlesheets4)
#Get foas from questionnaire
url_gs <- 'https://docs.google.com/spreadsheets/d/15SY9gpr5ELo0dLRYZNjqzNzOKbF8JYtkI42eBIZDe68/edit#gid=597634711'
#themes ========================================================================
foas_questonnaire <- read_sheet(url_gs, 'FOAs')
#themes ========================================================================
foas_questonnaire <- read_sheet(url_gs, 'FOAs') %>%
select(FOA_code, `FoA new name` = FOA_new_name)
#themes ========================================================================
foas_questonnaire <- read_sheet(url_gs, 'FOAs') %>%
select(FoA_code, `FoA new name` = FOA_new_name)
#themes ========================================================================
foas_questonnaire <- read_sheet(url_gs, 'FOAs') %>%
select(FoA_code, FOA_new_name = `FoA new name` )
#themes ========================================================================
foas_questonnaire <- read_sheet(url_gs, 'FOAs') %>%
select(FoA_code, FOA_new_name = `FoA new name`, theme_code )
View(foas_questonnaire)
#themes ========================================================================
foas_questonnaire <- read_sheet(url_gs, 'FOAs') %>%
select(FOACode = FoA_code, FOA_new_name = `FoA new name`, theme_code ) %>%
#themes ========================================================================
foas_questonnaire <- read_sheet(url_gs, 'FOAs') %>%
select(FOACode = FoA_code, FOA_new_name = `FoA new name`, theme_code )
#themes ========================================================================
foas_questonnaire <- read_sheet(url_gs, 'FOAs') %>%
select(FOACode = FoA_code, FOA_new_name = `FoA new name`, theme_code )
#themes ========================================================================
foas_questonnaire_raw <- read_sheet(url_gs, 'FOAs')
foas_joint <- foas_questonnaire_raw %>%
select(FOACode = FoA_code, FOA_new_name = `FoA new name`, theme_code ) %>%
foas_joint <- foas_questonnaire_raw %>%
select(FOACode = FoA_code, FOA_new_name = `FoA new name`, theme_code )
foas_joint <- foas_questonnaire_raw %>%
select(FOACode = FoA_code, FOA_new_name = `FoA new name`, theme_code )
foas_joint <- foas_questonnaire_raw %>%
select(FOACode = FoA_code, FOA_new_name = `FoA new name`, theme_code) %>%
full_join(foas_projects)
foas_joint <- foas_questonnaire_raw %>%
select(FOACode = FoA_code, FOA_new_name = `FoA new name`, theme_code) %>%
mutate(FOACode = as.character(FOACode)) %>%
full_join(foas_projects)
View(foas_joint)
foas_joint <- foas_questonnaire_raw %>%
select(FOACode = FoA_code, FOA_new_name = `FoA new name`, theme_code) %>%
mutate(FOACode = as.character(FOACode),
FOACode_1 = ifelse(length(FOACode) == 1, paste0('0', FOACode), FOACode)) %>%
full_join(foas_projects)
foas_joint <- foas_questonnaire_raw %>%
select(FOACode = FoA_code, FOA_new_name = `FoA new name`, theme_code) %>%
mutate(FOACode = as.character(FOACode),
FOACode_1 = ifelse(str_length(FOACode) == 1, paste0('0', FOACode), FOACode)) %>%
full_join(foas_projects)
foas_joint <- foas_questonnaire_raw %>%
select(FOACode = FoA_code, FOA_new_name = `FoA new name`, theme_code) %>%
mutate(FOACode = as.character(FOACode),
t = str_length(FOACode))
foas_joint <- foas_questonnaire_raw %>%
select(FOACode = FoA_code, FOA_new_name = `FoA new name`, theme_code) %>%
mutate(FOACode = as.character(FOACode),
t = str_length(FOACode),
FOACode_1 = ifelse(t == 1, paste0('0', FOACode), FOACode))
foas_joint <- foas_questonnaire_raw %>%
select(FOACode = FoA_code, FOA_new_name = `FoA new name`, theme_code) %>%
mutate(FOACode = as.character(FOACode),
t = str_length(FOACode),
FOACode = ifelse(t == 1, paste0('0', FOACode), FOACode)) %>%
full_join(foas_projects)
foas_joint <- foas_questonnaire_raw %>%
select(FOACode = FoA_code, FOA_new_name = `FoA new name`, theme_code) %>%
mutate(FOACode = as.character(FOACode),
t = str_length(FOACode),
FOACode = ifelse(t == 1, paste0('0', FOACode), FOACode)) %>%
full_join(foas_projects) %>%
arrange(FOACode)
foas_joint <- foas_questonnaire_raw %>%
select(FOACode = FoA_code, FOA_new_name = `FoA new name`, theme_code) %>%
mutate(FOACode = as.character(FOACode),
t = str_length(FOACode),
FOACode = ifelse(t == 1, paste0('0', FOACode), FOACode),
FOACode_new) %>%
full_join(foas_projects) %>%
arrange(FOACode)
foas_joint <- foas_questonnaire_raw %>%
select(FOACode = FoA_code, FOA_new_name = `FoA new name`, theme_code) %>%
mutate(FOACode = as.character(FOACode),
t = str_length(FOACode),
FOACode = ifelse(t == 1, paste0('0', FOACode), FOACode),
FOACode_new = FOACode)   %>%
full_join(foas_projects) %>%
arrange(FOACode)
foas_joint <- foas_questonnaire_raw %>%
select(FOACode = FoA_code, FOA_new_name = `FoA new name`, theme_code) %>%
mutate(FOACode = as.character(FOACode),
t = str_length(FOACode),
FOACode = ifelse(t == 1, paste0('0', FOACode), FOACode),
FOACode_new = FOACode)   %>%
full_join(foas_projects) %>%
arrange(FOACode) %>%
rename(FOA_old_name = FOADescription)
foas_joint <- foas_questonnaire_raw %>%
select(FOACode = FoA_code, FOA_new_name = `FoA new name`, theme_code) %>%
mutate(FOACode = as.character(FOACode),
t = str_length(FOACode),
FOACode = ifelse(t == 1, paste0('0', FOACode), FOACode),
FOACode_new = FOACode)   %>%
full_join(foas_projects) %>%
arrange(FOACode) %>%
rename(FOA_old_name = FOADescription) %>%
relocate(FOACode, FOA_old_name, FOA_new_name)
export(foas_joint, 'data/1.reference/checks/FOAs.xlsx')
export(foas_joint, 'data/1.reference/checks/FOAs_translation.xlsx')
foas_joint <- foas_questonnaire_raw %>%
select(FOACode = FoA_code, FOA_new_name = `FoA new name`, theme_code) %>%
mutate(FOACode = as.character(FOACode),
t = str_length(FOACode),
FOACode = ifelse(t == 1, paste0('0', FOACode), FOACode),
FOACode_new = FOACode)   %>%
full_join(foas_projects) %>%
arrange(FOACode) %>%
rename(FOA_old_name = FOADescription) %>%
select(FOACode, FOA_old_name, FOA_new_name)
View(foas_joint)
foas_joint <- foas_questonnaire_raw %>%
select(FOACode = FoA_code, FOA_new_name = `FoA new name`, theme_code) %>%
mutate(FOACode = as.character(FOACode),
t = str_length(FOACode),
FOACode = ifelse(t == 1, paste0('0', FOACode), FOACode),
FOACode_new = FOACode)   %>%
full_join(foas_projects) %>%
arrange(FOACode) %>%
rename(FOA_old_name = FOADescription) %>%
select(FOACode, FOA_old_name, FOA_new_name, total_projects)
View(foas_joint)
export(foas_joint, 'data/1.reference/checks/FOAs_translation.xlsx')
export(foas_joint, 'data/1.reference/checks/FOAs_translation.xlsx', overwrite = T)
mapping <- import('data/1.reference/Copy of FOA mapping - old to new.xlsx')
View(mapping)
mapping <- import('data/1.reference/Copy of FOA mapping - old to new.xlsx') %>%
filter(!is.na(old))
foas_mapped <- foas_projects %>%
left_join(mapping, by = c("old" = "FOACode"))
foas_mapped <- foas_projects %>%
left_join(mapping, by = c("FOACode" = "old" ))
View(foas_mapped)
View(mapping)
foas_joint <- foas_questonnaire_raw %>%
select(FOACode = FoA_code, FOA_new_name = `FoA new name`, theme_code) %>%
mutate(FOACode = as.character(FOACode),
t = str_length(FOACode),
FOACode = ifelse(t == 1, paste0('0', FOACode), FOACode),
FOACode_new = FOACode)   %>%
full_join(foas_mapped) %>%
arrange(FOACode) %>%
rename(FOA_old_name = FOADescription) %>%
select(FOACode, FOA_old_name, FOA_new_name, total_projects)
View(foas_joint)
foas_joint <- foas_questonnaire_raw %>%
select(FOACode = FoA_code, FOA_new_name = `FoA new name`, theme_code) %>%
mutate(FOACode = as.character(FOACode),
t = str_length(FOACode),
FOACode = ifelse(t == 1, paste0('0', FOACode), FOACode),
FOACode_new = FOACode)   %>%
full_join(foas_mapped) %>%
arrange(FOACode) %>%
rename(FOA_old_name = FOADescription) %>%
select(FOACode, FOA_old_name, FOA_new_name, total_projects, new)
foas_mapped <- foas_projects %>%
left_join(mapping, by = c("FOACode" = "old" )) %>%
mutate(code = ifelse(is.na(new), FOACode, new))
foas_mapped <- foas_projects %>%
left_join(mapping, by = c("FOACode" = "old" )) %>%
mutate(code = ifelse(is.na(new), FOACode, new)) %>%
arrange(code)
foas_mapped <- foas_projects %>%
left_join(mapping, by = c("FOACode" = "old" )) %>%
mutate(code = ifelse(is.na(new), FOACode, new)) %>%
relocate(code)
foas_mapped <- foas_projects %>%
left_join(mapping, by = c("FOACode" = "old" )) %>%
mutate(FOACode_new = ifelse(is.na(new), FOACode, new)) %>%
relocate(FOACode_new)
foas_mapped <- foas_projects %>%
left_join(mapping, by = c("FOACode" = "old" )) %>%
mutate(FOACode_new = ifelse(is.na(new), FOACode, new)) %>%
relocate(FOACode_new) %>%
filter(!is.na(FOACode_new))
View(foas_projects)
#Get the new IDs of FOAS
foas_mapped <- foas_projects %>%
#join FOAs from prjects with mapping
left_join(mapping, by = c("FOACode" = "old" )) %>%
#There are some new codes that do not have old one
mutate(FOACode_new = ifelse(is.na(new), FOACode, new)) %>%
relocate(FOACode_new) %>%
#there are projects with missing FOAs
filter(!is.na(FOACode_new))
#Get the new IDs of FOAS
foas_mapped <- foas_projects %>%
#join FOAs from prjects with mapping
left_join(mapping, by = c("FOACode" = "old" )) %>%
#There are some new codes that do not have old one
mutate(FOACode_new = ifelse(is.na(new), FOACode, new)) %>%
relocate(FOACode_new) %>%
#there are projects with missing FOAs
filter(!is.na(FOACode_new)) %>%
select(FOACode_new, FOACode_old = FOACode, total_projects)
#Get the new IDs of FOAS
foas_mapped <- foas_projects %>%
#join FOAs from prjects with mapping
left_join(mapping, by = c("FOACode" = "old" )) %>%
#There are some new codes that do not have old one
mutate(FOACode_new = ifelse(is.na(new), FOACode, new)) %>%
relocate(FOACode_new) %>%
#there are projects with missing FOAs
filter(!is.na(FOACode_new)) %>%
select(FOACode_new, FOACode_old = FOACode,
FOA_old = FOADescription,
total_projects)
foas_joint <- foas_questonnaire_raw %>%
select(FOACode_new = FoA_code, FOA_new = `FoA new name`, theme_code)
foas_joint <- foas_questonnaire_raw %>%
select(FOACode_new = FoA_code, FOA_new = `FoA new name`, theme_code) %>%
#Make the format consistent
mutate(FOACode = as.character(FOACode),
t = str_length(FOACode),
FOACode = ifelse(t == 1, paste0('0', FOACode), FOACode),
FOACode_new = FOACode)   %>%
full_join(foas_mapped)
foas_joint <- foas_questonnaire_raw %>%
select(FOACode_new = FoA_code, FOA_new = `FoA new name`, theme_code) %>%
#Make the format consistent
mutate(FOACode_new = as.character(FOACode_new),
t = str_length(FOACode_new),
FOACode_new = ifelse(t == 1, paste0('0', FOACode_new), FOACode_new)
)   %>%
full_join(foas_mapped)
View(foas_joint)
foas_joint <- foas_questonnaire_raw %>%
select(FOACode_new = FoA_code, FOA_new = `FoA new name`, theme_code) %>%
#Make the format consistent
mutate(FOACode_new = as.character(FOACode_new),
t = str_length(FOACode_new),
FOACode_new = ifelse(t == 1, paste0('0', FOACode_new), FOACode_new)
)   %>%
full_join(foas_mapped) %>%
arrange(FOACode)
foas_joint <- foas_questonnaire_raw %>%
select(FOACode_new = FoA_code, FOA_new = `FoA new name`, theme_code) %>%
#Make the format consistent
mutate(FOACode_new = as.character(FOACode_new),
t = str_length(FOACode_new),
FOACode_new = ifelse(t == 1, paste0('0', FOACode_new), FOACode_new)
)   %>%
full_join(foas_mapped) %>%
arrange(FOACode_new)
foas_joint <- foas_questonnaire_raw %>%
select(FOACode_new = FoA_code, FOA_new = `FoA new name`, theme_code) %>%
#Make the format consistent
mutate(FOACode_new = as.character(FOACode_new),
FOACode_new = ifelse(str_length(FOACode_new) == 1, paste0('0', FOACode_new), FOACode_new)
)   %>%
full_join(foas_mapped) %>%
arrange(FOACode_new)
foas_joint <- foas_questonnaire_raw %>%
select(FOACode_new = FoA_code, FOA_new = `FoA new name`, theme_code) %>%
#Make the format consistent
mutate(FOACode_new = as.character(FOACode_new),
FOACode_new = ifelse(str_length(FOACode_new) == 1, paste0('0', FOACode_new), FOACode_new)
)   %>%
full_join(foas_mapped) %>%
arrange(FOACode_new)
foas_joint <- foas_questonnaire_raw %>%
select(FOACode_new = FoA_code, FOA_new = `FoA new name`, theme_code) %>%
#Make the format consistent
mutate(FOACode_new = as.character(FOACode_new),
FOACode_new = ifelse(str_length(FOACode_new) == 1, paste0('0', FOACode_new), FOACode_new)
)   %>%
full_join(foas_mapped) %>%
arrange(FOACode_new) %>%
relocate(FOACode_new, FOACoce_old)
foas_joint <- foas_questonnaire_raw %>%
select(FOACode_new = FoA_code, FOA_new = `FoA new name`, theme_code) %>%
#Make the format consistent
mutate(FOACode_new = as.character(FOACode_new),
FOACode_new = ifelse(str_length(FOACode_new) == 1, paste0('0', FOACode_new), FOACode_new)
)   %>%
full_join(foas_mapped) %>%
arrange(FOACode_new) %>%
relocate(FOACode_new, FOACode_old)
foas_joint <- foas_questonnaire_raw %>%
select(FOACode_new = FoA_code, FOA_new = `FoA new name`, theme_code) %>%
#Make the format consistent
mutate(FOACode_new = as.character(FOACode_new),
FOACode_new = ifelse(str_length(FOACode_new) == 1, paste0('0', FOACode_new), FOACode_new)
)   %>%
full_join(foas_mapped) %>%
arrange(FOACode_new) %>%
relocate(FOACode_new, FOACode_old,
FOA_new, FOA_old)
View(mapping)
select(FOACode, FOA_old_name, FOA_new_name, total_projects, new)
#Get the names of the new FOAs as they are in the questionnaire
foas_joint <- foas_questonnaire_raw %>%
select(FOACode_new = FoA_code, FOA_new = `FoA new name`, theme_code) %>%
#Make the format consistent
mutate(FOACode_new = as.character(FOACode_new),
FOACode_new = ifelse(str_length(FOACode_new) == 1, paste0('0', FOACode_new), FOACode_new)
)   %>%
full_join(foas_mapped) %>%
arrange(FOACode_new) %>%
relocate(FOACode_new, FOACode_old,
FOA_new, FOA_old)
export(foas_joint, 'data/1.reference/checks/FOAs_translation.xlsx', overwrite = T)
#Export
export(foas_joint, 'data/1.reference/checks/FOAs_translation.xlsx', overwrite = T)
export(foas_joint, 'data/9.lookups/foas.rds')
#Get the names of the new FOAs as they are in the questionnaire
foas_joint <- foas_questonnaire_raw %>%
select(FOACode_new = FoA_code, FOA_new = `FoA new name`, theme_code, theme = `Thematic Area`) %>%
#Make the format consistent
mutate(FOACode_new = as.character(FOACode_new),
FOACode_new = ifelse(str_length(FOACode_new) == 1, paste0('0', FOACode_new), FOACode_new)
)   %>%
full_join(foas_mapped) %>%
arrange(FOACode_new) %>%
relocate(FOACode_new, FOACode_old,
FOA_new, FOA_old)
View(foas_joint)
#Get the names of the new FOAs as they are in the questionnaire
foas_joint <- foas_questonnaire_raw %>%
select(FOACode_new = FoA_code, FOA_new = `FoA new name`, theme_code, theme = `Thematic Area`) %>%
#Make the format consistent
mutate(FOACode_new = as.character(FOACode_new),
FOACode_new = ifelse(str_length(FOACode_new) == 1, paste0('0', FOACode_new), FOACode_new)
)   %>%
full_join(foas_mapped) %>%
arrange(FOACode_new) %>%
relocate(FOACode_new, FOACode_old,
FOA_new, FOA_old) %>%
mutate(t = theme_suffix(theme_code))
#Get the names of the new FOAs as they are in the questionnaire
foas_joint <- foas_questonnaire_raw %>%
select(FOACode_new = FoA_code, FOA_new = `FoA new name`, theme_code, theme = `Thematic Area`) %>%
#Make the format consistent
mutate(FOACode_new = as.character(FOACode_new),
FOACode_new = ifelse(str_length(FOACode_new) == 1, paste0('0', FOACode_new), FOACode_new)
)   %>%
full_join(foas_mapped) %>%
arrange(FOACode_new) %>%
relocate(FOACode_new, FOACode_old,
FOA_new, FOA_old) %>%
mutate(theme = names_themes(theme_suffix(theme_code)))
export(foas_joint, 'data/9.lookups/foas.rds')
#get improvements
#from questionnaire
improvements_raw <- read_sheet(url_gs, 'improvements')
foas_joint_imp <- foas_joint %>%
left_join(select(improvements_raw, FOA_new = FOA_code))
foas_joint_imp <- foas_joint %>%
left_join(select(improvements_raw, FOA_new = FoA_code, Improvement))
#get improvements
#from questionnaire
improvements_raw <- read_sheet(url_gs, 'improvements') %>%
mutate(FOACode_new = as.character(FoA_code),
FOACode_new = ifelse(str_length(FOACode_new) == 1, paste0('0', FOACode_new), FOACode_new)
)
foas_joint_imp <- foas_joint %>%
left_join(improvements_raw)
View(foas_joint_imp)
#get improvements
#from questionnaire
improvements_raw <- read_sheet(url_gs, 'improvements') %>%
mutate(FOACode_new = as.character(FoA_code),
FOACode_new = ifelse(str_length(FOACode_new) == 1, paste0('0', FOACode_new), FOACode_new)
) %>%
select(FOACode_new, Improvement)
foas_joint_imp <- foas_joint %>%
left_join(improvements_raw)
foas_joint_imp <- foas_joint %>%
left_join(improvements_raw)
#Export
export(foas_joint, 'data/1.reference/checks/FOAs_translation.xlsx', overwrite = T)
export(foas_joint, 'data/9.lookups/foas.rds')
